
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin • Productos</title>
  <link rel="stylesheet" href="./admin.css">
</head>
<body>
  <div class="layout">
    <aside class="aside">
      <div class="brand">GeekStore • Admin</div>
      <nav>
        <ul class="menu">
          <li><a href="./index.html">Dashboard</a></li>
          <li><a href="./productos.html" class="active">Productos</a></li>
          <li><a href="./usuarios.html" data-role-visible="Administrador">Usuarios</a></li>
          <li><a href="#" id="logoutBtn">Cerrar sesión</a></li>
        </ul>
      </nav>
    </aside>

    <div>
      <header class="header">
        <div class="space">
          <input class="search" id="q" type="search" placeholder="Buscar por código o nombre">
          <button class="btn ghost" id="clear">Limpiar</button>
        </div>
        <div class="right"><span class="tag" data-user>-</span></div>
      </header>

      <main class="main">
        <div class="grid two">
          <div class="card">
            <h2>Nuevo / Editar producto</h2>
            <form id="productForm" class="form" novalidate>
              <input type="hidden" id="id">
              <div class="row">
                <div>
                  <label for="codigo">Código *</label>
                  <input id="codigo" required>
                  <small class="error" id="e_codigo"></small>
                </div>
                <div>
                  <label for="nombre">Nombre *</label>
                  <input id="nombre" required>
                  <small class="error" id="e_nombre"></small>
                </div>
              </div>
              <div>
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" maxlength="500" placeholder="Máximo 500 caracteres"></textarea>
                <small class="error" id="e_descripcion"></small>
              </div>
              <div class="row">
                <div>
                  <label for="precio">Precio *</label>
                  <input id="precio" type="number" step="0.01" min="0" required>
                  <small class="error" id="e_precio"></small>
                </div>
                <div>
                  <label for="stock">Stock *</label>
                  <input id="stock" type="number" step="1" min="0" required>
                  <small class="error" id="e_stock"></small>
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="stockCritico">Stock crítico</label>
                  <input id="stockCritico" type="number" step="1" min="0">
                  <small class="error" id="e_stockCritico"></small>
                </div>
                <div>
                  <label for="categoria">Categoría *</label>
                  <select id="categoria" required>
                    <option value="">Seleccione</option>
                    <option>Funko</option>
                    <option>Figura</option>
                    <option>Poster</option>
                    <option>Mascara</option>
                  </select>
                  <small class="error" id="e_categoria"></small>
                </div>
              </div>
              <div>
                <label for="imagen">Imagen (URL)</label>
                <input id="imagen" type="url" placeholder="https://...">
              </div>
              <div class="space">
                <button class="btn" type="submit">Guardar</button>
                <button class="btn secondary" type="button" id="resetBtn">Reset</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2>Listado</h2>
            <div class="space" style="margin:.5rem 0 1rem">
              <button class="btn ghost" id="exportBtn">Exportar JSON</button>
              <label class="btn secondary" for="importFile" style="cursor:pointer">Importar JSON</label>
              <input id="importFile" type="file" accept="application/json" style="display:none">
            </div>
            <table class="table" id="tabla">
              <thead>
                <tr>
                  <th>Código</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Categoría</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="./admin.bundle.js"></script>
  <script>
  (function(){
    Admin.requireAuth();
    const s = Admin.getSession();
    const badge = document.querySelector('[data-user]'); if (badge) badge.textContent = `${s.usuario} • ${s.rol}`;
    if (s?.rol === 'Vendedor'){
      document.querySelectorAll('[data-role-visible="Administrador"]').forEach(el => el.style.display = 'none');
    }

    const KEY = 'admin_products';
    let data = Admin.loadLS(KEY, []);
    let editingId = null;

    const q = document.getElementById('q');
    const clearBtn = document.getElementById('clear');
    const tbody = document.querySelector('#tabla tbody');
    const form = document.getElementById('productForm');
    const resetBtn = document.getElementById('resetBtn');

    const logout = (e) => { if(e) e.preventDefault(); Admin.clearSession(); location.href='./login.html'; };
    document.getElementById('logoutBtn').addEventListener('click', logout);

    function render(list){
      list = list || data;
      tbody.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        const stockWarn = (p.stockCritico != null && p.stockCritico !== '' && Number(p.stock) <= Number(p.stockCritico));
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${Admin.formatMoney(p.precio)}</td>
          <td>${p.stock} ${stockWarn ? '<span class="chip warn">⚠ Stock crítico</span>' : ''}</td>
          <td><span class="chip">${p.categoria}</span></td>
          <td class="flex">
            ${p.imagen ? `<a class="btn ghost" href="${p.imagen}" target="_blank">Ver</a>` : ''}
            <button class="btn ghost" data-edit="${p.id}">Editar</button>
            <button class="btn danger" data-del="${p.id}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    render();

    function getFormValues(){
      return {
        id: editingId || Admin.uid(),
        codigo: form.codigo.value.trim(),
        nombre: form.nombre.value.trim(),
        descripcion: form.descripcion.value.trim(),
        precio: form.precio.value === '' ? '' : Number(form.precio.value),
        stock: form.stock.value === '' ? '' : Number(form.stock.value),
        stockCritico: form.stockCritico.value === '' ? '' : Number(form.stockCritico.value),
        categoria: form.categoria.value,
        imagen: form.imagen.value.trim()
      };
    }
    function setErrors(errors){
      ['codigo','nombre','descripcion','precio','stock','stockCritico','categoria'].forEach(k => {
        const el = document.getElementById('e_'+k);
        el.textContent = errors[k] || '';
      });
    }

    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const payload = getFormValues();
      const errors = Admin.validateProduct(payload);
      setErrors(errors);
      if (Object.keys(errors).length) return;
      const idx = data.findIndex(x => x.id === payload.id);
      if (idx >= 0) data[idx] = payload; else data.push(payload);
      Admin.saveLS(KEY, data);
      render();
      form.reset();
      editingId = null;
    });

    resetBtn.addEventListener('click', ()=>{ form.reset(); editingId = null; setErrors({}); });

    tbody.addEventListener('click', (ev)=>{
      const id = ev.target.dataset.edit || ev.target.dataset.del;
      if(!id) return;
      if (ev.target.dataset.edit){
        const p = data.find(x => x.id === id);
        if (!p) return;
        editingId = p.id;
        form.codigo.value = p.codigo;
        form.nombre.value = p.nombre;
        form.descripcion.value = p.descripcion || '';
        form.precio.value = p.precio;
        form.stock.value = p.stock;
        form.stockCritico.value = p.stockCritico ?? '';
        form.categoria.value = p.categoria;
        form.imagen.value = p.imagen || '';
        setErrors({});
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (ev.target.dataset.del){
        if (confirm('¿Eliminar producto?')){
          data = data.filter(x => x.id !== id);
          Admin.saveLS(KEY, data);
          render();
        }
      }
    });

    q.addEventListener('input', ()=>{
      const term = q.value.trim().toLowerCase();
      if (!term){ render(); return; }
      render(data.filter(p => p.codigo.toLowerCase().includes(term) || p.nombre.toLowerCase().includes(term)));
    });
    clearBtn.addEventListener('click', ()=>{ q.value=''; render(); });

    // Export / Import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      Admin.exportJSON('productos.json', data);
    });
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      Admin.importJSON(file, (err, json)=>{
        if(err){ alert('JSON inválido'); return; }
        if(!Array.isArray(json)){ alert('El archivo debe ser un arreglo de productos'); return; }
        data = json;
        Admin.saveLS(KEY, data);
        render();
        e.target.value = '';
      });
    });
  })();
  </script>
</body>
</html>
